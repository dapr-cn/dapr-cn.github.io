<!doctype html><html lang=zh-hans class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.82.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>参考：actor | Dapr 文档库</title><meta property="og:title" content="参考：actor"><meta property="og:description" content="在生产中使用 PHP actor"><meta property="og:type" content="article"><meta property="og:url" content="https://docs.dapr.io/developing-applications/sdks/php/php-actors/php-actor-reference/"><meta property="article:section" content="developing-applications"><meta property="article:modified_time" content="2021-04-05T10:31:57+08:00"><meta property="og:site_name" content="Dapr 文档库"><meta itemprop=name content="参考：actor"><meta itemprop=description content="在生产中使用 PHP actor"><meta itemprop=dateModified content="2021-04-05T10:31:57+08:00"><meta itemprop=wordCount content="620"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="参考：actor"><meta name=twitter:description content="在生产中使用 PHP actor"><link rel=preload href=/scss/main.min.4f5599e79bfe08564bf511593ce81932a192063e53321ddad09d47759e704c96.css as=style><link href=/scss/main.min.4f5599e79bfe08564bf511593ce81932a192063e53321ddad09d47759e704c96.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="206" height="206" viewBox="0 0 206 206" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>white on dark</title><desc>Created with Sketch.</desc><defs/><g id="white-on-dark" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path d="M63.08125 128H51.55v-3.621094C50.448432 125.761726 49.3351619 126.769528 48.2101562 127.402344 46.2413964 128.503912 44.0031375 129.054688 41.4953125 129.054688c-4.0547078.0-7.6640467-1.39451800000001-10.828125-4.183594-3.7734564-3.328142-5.6601563-7.734348-5.6601563-13.21875.0-5.578153 1.9335745-10.031234 5.8007813-13.3593752C33.8781404 95.644518 37.4054488 94.3203125 41.3898437 94.3203125c2.3203242.0 4.4999899.492182600000007 6.5390625 1.4765625C49.1007871 96.3593778 50.3078063 97.2851498 51.55 98.5742188V75.1953125H63.08125V128zM51.9015625 111.6875c0-2.06251-.7265552-3.814446-2.1796875-5.255859-1.4531323-1.44141399999999-3.2109272-2.16211-5.2734375-2.16211-2.2968865.0-4.1835864.867178999999993-5.6601563 2.601563-1.1953184 1.406257-1.7929687 3.011709-1.7929687 4.816406S37.5929628 115.097649 38.7882812 116.503906C40.2414135 118.23829 42.1281134 119.105469 44.4484375 119.105469c2.0859479.0 3.8496022-.714837000000003 5.2910156-2.144531 1.4414135-1.429695 2.1621094-3.18749 2.1621094-5.273438zM106.329687 128H94.7984375v-3.621094C93.6968695 125.761726 92.5835994 126.769528 91.4585937 127.402344 89.4898339 128.503912 87.251575 129.054688 84.74375 129.054688c-4.0547078.0-7.6640467-1.39451800000001-10.828125-4.183594C70.1421686 121.542952 68.2554687 117.136746 68.2554687 111.652344 68.2554687 106.074191 70.1890432 101.62111 74.05625 98.2929688 77.1265779 95.644518 80.6538863 94.3203125 84.6382812 94.3203125c2.3203242.0 4.4999899.492182600000007 6.5390625 1.4765625C92.3492246 96.3593778 93.5562438 97.2851498 94.7984375 98.5742188V95.375H106.329687V128zM95.15 111.6875c0-2.06251-.726555200000007-3.814446-2.1796875-5.255859C91.5171802 104.990227 89.7593853 104.269531 87.696875 104.269531 85.3999885 104.269531 83.5132886 105.13671 82.0367187 106.871094 80.8414003 108.277351 80.24375 109.882803 80.24375 111.6875S80.8414003 115.097649 82.0367187 116.503906C83.489851 118.23829 85.3765509 119.105469 87.696875 119.105469 89.7828229 119.105469 91.5464772 118.390632 92.9878906 116.960938 94.4293041 115.531243 95.15 113.773448 95.15 111.6875zM150.878906 111.722656c0 5.578153-1.93357399999999 10.031234-5.800781 13.359375C142.007797 127.730482 138.480489 129.054688 134.496094 129.054688c-2.320324.0-4.49999-.492183000000011-6.539063-1.476563-1.171881-.562503000000007-2.3789-1.488275-3.621094-2.777344V144.3125h-11.53125V95.375h11.53125v3.6210938C125.367193 97.636712 126.480463 96.6289095 127.675781 95.9726562c1.96876-1.101568 4.207019-1.6523437 6.714844-1.6523437C138.445333 94.3203125 142.054672 95.7148298 145.21875 98.5039062 148.992206 101.832048 150.878906 106.238254 150.878906 111.722656zM138.890625 111.6875c0-1.851572-.585932000000014-3.457024-1.757813-4.816406C135.656243 105.13671 133.757824 104.269531 131.4375 104.269531c-2.085948.0-3.849602.714837000000003-5.291016 2.144531-1.441413 1.429695-2.162109 3.18749-2.162109 5.273438.0 2.06251.726555000000005 3.814446 2.179687 5.255859C127.617195 118.384773 129.37499 119.105469 131.4375 119.105469c2.320324.0 4.20702399999999-.867178999999993 5.660156-2.601563 1.19531900000001-1.406257 1.792969-3.011709 1.792969-4.816406zm41.63125-5.660156C178.904679 105.253902 177.264071 104.867188 175.6 104.867188c-3.79689399999998.0-6.25780699999999 1.546859-7.382813 4.640624C167.79531 110.632818 167.584375 112.144522 167.584375 114.042969V128h-11.53125V95.375h11.53125v5.34375C168.803131 98.820303 170.115618 97.449223 171.521875 96.6054688c1.898447-1.1250057 4.14842400000001-1.6875 6.75-1.6875C178.881253 94.9179688 179.631246 94.9531246 180.521875 95.0234375V106.027344z" id="dapr" fill="#fff"/><polygon id="tie" fill="#fff" fill-rule="nonzero" points="112.713867 128.237305 124.324219 128.237305 125.324219 155.49707 118.519043 160.265625 111.713867 155.49707"/><rect id="Rectangle-4" fill="#fff" fill-rule="nonzero" x="86.6816586" y="46" width="44.0478543" height="31" rx="2"/><rect id="Rectangle-4" fill="#000" fill-rule="nonzero" opacity=".0799999982" x="86.6816586" y="46" width="16.2935291" height="31"/><rect id="Rectangle-3" fill="#fff" fill-rule="nonzero" x="72.7718099" y="75" width="71.2879747" height="7.44032012" rx="3.72016"/><rect id="Rectangle-4" fill="#000" fill-rule="nonzero" opacity=".0799999982" x="72.7718099" y="75" width="22.0566132" height="9.15731707"/></g></svg></span><span class=font-weight-bold>Dapr 文档库</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://dapr.io target=_blank><span>Homepage</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/dapr target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://blog.dapr.io/posts target=_blank><span>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://aka.ms/dapr-discord target=_blank><span>Discord</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/dapr/community/blob/master/README.md target=_blank><span>Community</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>v1.0 (latest)</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=#>v1.0 (latest)</a>
<a class=dropdown-item href=https://v0-11.docs.dapr.io>v0.11</a>
<a class=dropdown-item href=https://github.com/dapr/docs/tree/v0.10.0>v0.10</a>
<a class=dropdown-item href=https://github.com/dapr/docs/tree/v0.9.0>v0.9</a>
<a class=dropdown-item href=https://github.com/dapr/docs/tree/v0.8.0>v0.8</a></div></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>简体中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/developing-applications/sdks/php/php-actors/php-actor-reference/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 " aria-label autocomplete=off></div></nav></header><div class="container-fluid td-default td-outer"><main role=main class=td-main><h2 id=代理模式>代理模式</h2><p>Actor 代理有四种处理方式。 每种模式都需要您在开发和生产过程中权衡。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
<span style=color:#a6e22e>\Dapr\Actors\Generators\ProxyFactory</span><span style=color:#f92672>::</span><span style=color:#a6e22e>GENERATED</span>;
<span style=color:#a6e22e>\Dapr\Actors\Generators\ProxyFactory</span><span style=color:#f92672>::</span><span style=color:#a6e22e>GENERATED_CACHED</span>;
<span style=color:#a6e22e>\Dapr\Actors\Generators\ProxyFactory</span><span style=color:#f92672>::</span><span style=color:#a6e22e>ONLY_EXISTING</span>;
<span style=color:#a6e22e>\Dapr\Actors\Generators\ProxyFactory</span><span style=color:#f92672>::</span><span style=color:#a6e22e>DYNAMIC</span>;
</code></pre></div><p>它可以使用 <code>dapr.actors.proxy.generate</code> 配置密钥。</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><a class="nav-link active" id=tabs-0-generated-tab data-toggle=tab href=#tabs-0-generated role=tab aria-controls=tabs-0-generated aria-selected=true>GENERATED</a></li><li class=nav-item><a class=nav-link id=tabs-0-generated_cached-tab data-toggle=tab href=#tabs-0-generated_cached role=tab aria-controls=tabs-0-generated_cached aria-selected=false>GENERATED_CACHED</a></li><li class=nav-item><a class=nav-link id=tabs-0-only_existing-tab data-toggle=tab href=#tabs-0-only_existing role=tab aria-controls=tabs-0-only_existing aria-selected=false>ONLY_EXISTING</a></li><li class=nav-item><a class=nav-link id=tabs-0-dynamic-tab data-toggle=tab href=#tabs-0-dynamic role=tab aria-controls=tabs-0-dynamic aria-selected=false>DYNAMIC</a></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade show active" id=tabs-0-generated role=tabpanel aria-labelled-by=tabs-0-generated-tab><br><p>这是默认的模式。 在这种模式下，每次请求都会生成一个 <code>eval</code>类， 它主要用于开发环境而不能应用于生产。</p></div><div class="tab-pane fade" id=tabs-0-generated_cached role=tabpanel aria-labelled-by=tabs-0-generated_cached-tab><br><p>这与 <code>ProxyModes::GENERATED</code> 相同，但这个类存储在临时文件中，所以不需要在每个请求中重新生成。 它不知道何时更新缓存的类，也无法手动生成文件时提供，因此不建议在开发中使用它</p></div><div class="tab-pane fade" id=tabs-0-only_existing role=tabpanel aria-labelled-by=tabs-0-only_existing-tab><br><p>在这种模式下，如果不存在代理类，将会抛出异常。 可以用在当你不想在生产生产环境中生成代码时 您必须确保class生成并自动加载。</p><h3 id=生成代理>生成代理</h3><p>您可以创建一个编写器脚本来根据需要生成代理，以利用<code>ONLY_EXISTING</code>模式。</p><p>创建 <code>ProxyCompiler.php</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProxyCompiler</span> {
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>PROXIES</span> <span style=color:#f92672>=</span> [
        <span style=color:#a6e22e>MyActorInterface</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
        <span style=color:#a6e22e>MyOtherActorInterface</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
    ];

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>PROXY_LOCATION</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>__DIR__</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;/proxies/&#39;</span>;

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>compile</span>() {
        <span style=color:#66d9ef>try</span> {
            $app <span style=color:#f92672>=</span> <span style=color:#a6e22e>\Dapr\App</span><span style=color:#f92672>::</span><span style=color:#a6e22e>create</span>();
            <span style=color:#66d9ef>foreach</span>(<span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>PROXIES</span> <span style=color:#66d9ef>as</span> $interface) {
                $output <span style=color:#f92672>=</span> $app<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>run</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>\DI\FactoryInterface</span> $factory) <span style=color:#66d9ef>use</span> ($interface) {
                    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>\Dapr\Actors\Generators\FileGenerator</span><span style=color:#f92672>::</span><span style=color:#a6e22e>generate</span>($interface, $factory);
                });
                $reflection <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ReflectionClass</span>($interface);
                $dapr_type <span style=color:#f92672>=</span> $reflection<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getAttributes</span>(<span style=color:#a6e22e>\Dapr\Actors\Attributes\DaprType</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>)[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>newInstance</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>type</span>;
                $filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;dapr_proxy_&#39;</span><span style=color:#f92672>.</span>$dapr_type<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;.php&#39;</span>;
                <span style=color:#a6e22e>file_put_contents</span>(<span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>PROXY_LOCATION</span><span style=color:#f92672>.</span>$filename, $output);
                <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;Compiled: </span><span style=color:#e6db74>$interface</span><span style=color:#e6db74>&#34;</span>;
            }
        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>Exception</span> $ex) {
            <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;Failed to generate proxy for </span><span style=color:#e6db74>$interface\n{</span>$ex<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getMessage</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74> on line </span><span style=color:#e6db74>{</span>$ex<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getLine</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74> in </span><span style=color:#e6db74>{</span>$ex<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getFile</span>()<span style=color:#e6db74>}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
        }
    }
}
</code></pre></div><p>然后在 <code>composer.json</code> 中为生成的代理添加一个 psr-4 自动加载器和脚本：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;autoload&#34;</span>: {
    <span style=color:#f92672>&#34;psr-4&#34;</span>: {
      <span style=color:#f92672>&#34;Dapr\\Proxies\\&#34;</span>: <span style=color:#e6db74>&#34;path/to/proxies&#34;</span>
    }
  },
  <span style=color:#f92672>&#34;scripts&#34;</span>: {
    <span style=color:#f92672>&#34;compile-proxies&#34;</span>: <span style=color:#e6db74>&#34;ProxyCompiler::compile&#34;</span>
  }
}
</code></pre></div><p>最后，将dapr配置为仅使用生成的代理：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
<span style=color:#75715e>// in config.php
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>return</span> [
    <span style=color:#e6db74>&#39;dapr.actors.proxy.generation&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>ProxyFactory</span><span style=color:#f92672>::</span><span style=color:#a6e22e>ONLY_EXISTING</span>,
];
</code></pre></div></div><div class="tab-pane fade" id=tabs-0-dynamic role=tabpanel aria-labelled-by=tabs-0-dynamic-tab><br><p>然而，在这种模式下，代理人满足了接口契约。 它实际上没有实现接口本身 (意指 <code>instanceof</code> 将是 <code>false</code>). 这种模式利用了PHP中的一些特性来工作，并适用于某些情况 其中code不能是<code>eval</code>&lsquo;d或生成。</p></div></div><h3 id=请求列表>请求列表</h3><p>无论使用哪种模式，创建actor代理都是非常方便的。 在创建actor代理对象时不会发出请求。</p><p>当您在代理对象上调用方法时，actor只会为您实现的方法提供服务。 <code>get_id()</code> 是本地处理的， <code>get_emergder()</code>, <code>delete_emergder()</code>, 等由 <code>daprd</code> 处理。</p><h2 id=添加actor实现>添加Actor实现</h2><p>PHP 中的每个执行者必须实现 <code>\Dapr\Actors\Iactor</code> 并使用 <code>\Dapr\Actors\ActorTrait</code> 特性。 这个支持反射. 使用 <code>\Dapr\Actors\Actor</code> 抽象基础类为您服务。 但是 如果您需要覆盖默认行为，您可以通过实现接口和使用特性来做到这一点。</p><h2 id=激活和停用>激活和停用</h2><p>当actor激活时，令牌文件将被写入临时目录（默认情况下，该目录位于linux下 <code>'/tmp/dapr_'+ sha256（concat（Dapr type，Id））&lt;/ code>和Windows上的&lt;code>'％temp％/ dapr_'+ sha256（concat（Dapr type，Id））&lt;/ code>）。 这种情况持续到actor或host停用。 这允许&lt;code> on_activation </code>被调用一次 并且只有Dapr激活host上的actor时才执行一次。</p><h2 id=性能>性能</h2><p>actor方法的执行效率非常高， <code>php-fpm</code> and <code>nginx</code>, 或 IIS 在 Windows 上有一个生产设置。 虽然actor是在每个请求上都会构造，actor状态密钥是按需加载，而不是在每个请求时加载。 在分别加载每个key时会有一些开销。 可以通过在状态中存储数据数组来缓解这种情况 ，为了速度而牺牲了一些可用性。 不建议从一开始就这样做，而是在需要 时作为一种优化。</p><h2 id=版本状态>版本状态</h2><p><code>ActorState</code>对象中的变量名直接对应于存储库中的键名。 这意味着如果更改一个变量的类型或名称，可能会出现错误。 To get around this, you may need to version your state object. In order to do this, you&rsquo;ll need to override how state is loaded and stored. There are many ways to approach this, one such solution might be something like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VersionedState</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>\Dapr\Actors\ActorState</span> {
    <span style=color:#e6db74>/**
</span><span style=color:#e6db74>     * @var int The current version of the state in the store. We give a default value of the current version. 
</span><span style=color:#e6db74>     * However, it may be in the store with a different value. 
</span><span style=color:#e6db74>     */</span>
    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>int</span> $state_version <span style=color:#f92672>=</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>VERSION</span>;

    <span style=color:#e6db74>/**
</span><span style=color:#e6db74>     * @var int The current version of the data
</span><span style=color:#e6db74>     */</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>VERSION</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;

    <span style=color:#e6db74>/**
</span><span style=color:#e6db74>     * Call when your actor activates.
</span><span style=color:#e6db74>     */</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>upgrade</span>() {
        <span style=color:#66d9ef>if</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>state_version</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>VERSION</span>) {
            $value <span style=color:#f92672>=</span> <span style=color:#66d9ef>parent</span><span style=color:#f92672>::</span><span style=color:#a6e22e>__get</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_versioned_key</span>(<span style=color:#e6db74>&#39;key&#39;</span>, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>state_version</span>));
            <span style=color:#75715e>// update the value after updating the data structure
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>parent</span><span style=color:#f92672>::</span><span style=color:#a6e22e>__set</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_versioned_key</span>(<span style=color:#e6db74>&#39;key&#39;</span>, <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>VERSION</span>), $value);
            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>state_version</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>VERSION</span>;
            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>save_state</span>();
        }
    }

    <span style=color:#75715e>// if you upgrade all keys as needed in the method above, you don&#39;t need to walk the previous
</span><span style=color:#75715e></span>    <span style=color:#75715e>// keys when loading/saving and you can just get the current version of the key.
</span><span style=color:#75715e></span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>get_previous_version</span>(<span style=color:#a6e22e>int</span> $version)<span style=color:#f92672>:</span> <span style=color:#a6e22e>int</span> {
        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>has_previous_version</span>($version) <span style=color:#f92672>?</span> $version <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> $version;
    }

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>has_previous_version</span>(<span style=color:#a6e22e>int</span> $version)<span style=color:#f92672>:</span> <span style=color:#a6e22e>bool</span> {
        <span style=color:#66d9ef>return</span> $version <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>;
    }

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>walk_versions</span>(<span style=color:#a6e22e>int</span> $version, <span style=color:#a6e22e>callable</span> $callback, <span style=color:#a6e22e>callable</span> $predicate)<span style=color:#f92672>:</span> <span style=color:#a6e22e>mixed</span> {
        $value <span style=color:#f92672>=</span> $callback($version);
        <span style=color:#66d9ef>if</span>($predicate($value) <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>has_previous_version</span>($version)) {
            <span style=color:#66d9ef>return</span> $value;
        }
        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>walk_versions</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_previous_version</span>($version), $callback, $predicate);
    }

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>get_versioned_key</span>(<span style=color:#a6e22e>string</span> $key, <span style=color:#a6e22e>int</span> $version) {
        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>has_previous_version</span>($version) <span style=color:#f92672>?</span> $version<span style=color:#f92672>.</span>$key <span style=color:#f92672>:</span> $key;
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __get(<span style=color:#a6e22e>string</span> $key)<span style=color:#f92672>:</span> <span style=color:#a6e22e>mixed</span> {
        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>walk_versions</span>(
            <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>VERSION</span>, 
            <span style=color:#a6e22e>fn</span>($version) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>parent</span><span style=color:#f92672>::</span><span style=color:#a6e22e>__get</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_versioned_key</span>($key, $version)),
            <span style=color:#a6e22e>fn</span>($value) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>isset</span>($value)
        );
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __isset(<span style=color:#a6e22e>string</span> $key)<span style=color:#f92672>:</span> <span style=color:#a6e22e>bool</span> {
        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>walk_versions</span>(
            <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>VERSION</span>,
            <span style=color:#a6e22e>fn</span>($version) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>parent</span><span style=color:#f92672>::</span><span style=color:#a6e22e>__isset</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_versioned_key</span>($key, $version)),
            <span style=color:#a6e22e>fn</span>($isset) <span style=color:#f92672>=&gt;</span> $isset
        );
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __set(<span style=color:#a6e22e>string</span> $key,<span style=color:#a6e22e>mixed</span> $value)<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span> {
        <span style=color:#75715e>// optional: you can unset previous versions of the key
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>parent</span><span style=color:#f92672>::</span><span style=color:#a6e22e>__set</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_versioned_key</span>($key, <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>VERSION</span>), $value);
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __unset(<span style=color:#a6e22e>string</span> $key) <span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span> {
        <span style=color:#75715e>// unset this version and all previous versions
</span><span style=color:#75715e></span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>walk_versions</span>(
            <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>VERSION</span>, 
            <span style=color:#a6e22e>fn</span>($version) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>parent</span><span style=color:#f92672>::</span><span style=color:#a6e22e>__unset</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_versioned_key</span>($key, $version)), 
            <span style=color:#a6e22e>fn</span>() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>false</span>
        );
    }
}
</code></pre></div><p>There&rsquo;s a lot to be optimized, and it wouldn&rsquo;t be a good idea to use this verbatim in production, but you can get the gist of how it would work. A lot of it will depend on your use case which is why there&rsquo;s not something like this in the SDK. For instance, in this example implementation, the previous value is kept for where there may be a bug during an upgrade; keeping the previous value allows for running the upgrade again, but you may wish to delete the previous value.</p></main><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/daprdev><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=YouTube aria-label=YouTube><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.youtube.com/channel/UCtpSQ9BLB_3EXdWAUQYwnRA><i class="fab fa-youtube"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Blog aria-label=Blog><a class=text-white target=_blank rel="noopener noreferrer" href=https://blog.dapr.io/posts><i class="fas fa-blog"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/dapr/><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel="noopener noreferrer" href=https://aka.ms/dapr-discord><i class="fab fa-discord"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Zoom aria-label=Zoom><a class=text-white target=_blank rel="noopener noreferrer" href=https://aka.ms/dapr-community-call><i class="fas fa-video"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 Dapr</small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.ad24b64b9b408e8a77066448b46cc4852b67062bc906a18a31a6967a5b2c3dfe.js integrity="sha256-rSS2S5tAjop3BmRItGzEhStnBivJBqGKMaaWelssPf4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script>docsearch({apiKey:'54ae43aa28ce8f00c54c8d5f544d29b9',indexName:'crawler_dapr',appId:'O0QLQGNF38',inputSelector:'.td-search-input',debug:!1})</script><script src=/js/copy-code-button.js></script></body></html>